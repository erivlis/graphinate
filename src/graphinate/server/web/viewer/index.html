<!DOCTYPE html>
<html lang="">
<head>
    <title>Graphinate Viewer</title>
    <script type="module"
            integrity="sha384-Dt9sd/AA7KNs3M8XRJs7rNwUZ9bRWhsKjVz4UpCle+pCI/lqdylOH3mcYcKRBPKF"
            crossorigin="anonymous">
        // Import ES module
        import * as Tweakpane from 'https://unpkg.com/tweakpane@4.0.5/dist/tweakpane.min.js';
        // Export it as a global variable
        window.Tweakpane = Tweakpane;
    </script>


    <script src="https://unpkg.com/3d-force-graph@1.76.1/dist/3d-force-graph.min.js"
            integrity="sha384-7PiolihqoWLaY+8+zoccK5LLtWiGzovYvg5gjpKkQYhL51yq4JYt6owMj3bzQFBc"
            crossorigin="anonymous"></script>
    <script src="https://unpkg.com/murmurhash-js@1.0.0/murmurhash3_gc.js"
            integrity="sha384-g+j9YCPmBDu4mlFm1UGyQFBh5P7x/xYGJvqbX/WFbzJC2V/wwBRCorSlQ1UaAED0"
            crossorigin="anonymous"></script>

    <!-- Append this element into the head element to apply the theme -->
    <style>
        body {
            margin: 0;
        }

        .tp-dfwv {
            height: 95vh;
            overflow-y: auto;
        }

        :root {
            --tp-base-background-color: hsla(40, 3%, 90%, 1.00);
            --tp-base-shadow-color: hsla(0, 0%, 0%, 0.30);
            --tp-button-background-color: hsla(40, 3%, 70%, 1.00);
            --tp-button-background-color-active: hsla(40, 3%, 55%, 1.00);
            --tp-button-background-color-focus: hsla(40, 3%, 60%, 1.00);
            --tp-button-background-color-hover: hsla(40, 3%, 65%, 1.00);
            --tp-button-foreground-color: hsla(40, 3%, 20%, 1.00);
            --tp-container-background-color: hsla(40, 3%, 70%, 1.00);
            --tp-container-background-color-active: hsla(40, 3%, 55%, 1.00);
            --tp-container-background-color-focus: hsla(40, 3%, 60%, 1.00);
            --tp-container-background-color-hover: hsla(40, 3%, 65%, 1.00);
            --tp-container-foreground-color: hsla(40, 3%, 20%, 1.00);
            --tp-groove-foreground-color: hsla(40, 3%, 40%, 1.00);
            --tp-input-background-color: hsla(120, 3%, 20%, 1.00);
            --tp-input-background-color-active: hsla(120, 3%, 35%, 1.00);
            --tp-input-background-color-focus: hsla(120, 3%, 30%, 1.00);
            --tp-input-background-color-hover: hsla(120, 3%, 25%, 1.00);
            --tp-input-foreground-color: hsla(120, 40%, 60%, 1.00);
            --tp-label-foreground-color: hsla(40, 3%, 50%, 1.00);
            --tp-monitor-background-color: hsla(120, 3%, 20%, 1.00);
            --tp-monitor-foreground-color: hsla(120, 40%, 60%, 0.80);
        }
    </style>
</head>
<body>
<div id="3d-graph"></div>
<script>
    let highestZIndex = 0;
    let lastPanelPosition = {top: 50, left: 50};

    function createFloatingPanel(url, title) {
        // Create the panel container
        const panel = document.createElement('div');
        panel.className = 'floating-panel';
        panel.style.position = 'absolute';
        panel.style.top = `${lastPanelPosition.top}px`;
        panel.style.left = `${lastPanelPosition.left}px`;
        panel.style.width = '400px';
        panel.style.height = '300px';
        panel.style.border = '4px solid #b5b3b0';
        panel.style.borderBottom = 'none'; // Remove bottom border
        panel.style.borderRadius = '5px'; // Smaller rounded corners
        panel.style.backgroundColor = '#fff';
        panel.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
        panel.style.resize = 'both';
        panel.style.overflow = 'hidden'; // Prevent panel from scrolling
        panel.style.zIndex = ++highestZIndex; // Set zIndex to one higher than the highest

        // Update the last panel position
        lastPanelPosition.top += 5;
        lastPanelPosition.left += 5;

        function lowerZIndexForHigherPanels(panel) {
            const panels = document.querySelectorAll('.floating-panel');
            panels.forEach(p => {
                const zIndex = parseInt(window.getComputedStyle(p).zIndex, 10);
                if (zIndex > parseInt(panel.style.zIndex, 10)) {
                    p.style.zIndex = zIndex - 1;
                }
            });
        }

        // Function to bring the panel to the front
        function bringToFront() {
            lowerZIndexForHigherPanels(panel);
            // Set the current panel's zIndex to the highest
            panel.style.zIndex = highestZIndex;
        }

        // Add event listener to bring the panel to the front on click
        panel.addEventListener('mousedown', (e) => {
            if (e.target !== closeButton && e.target !== maximizeToggleButton) {
                bringToFront();
            }
        });

        // Create the panel header
        const header = document.createElement('div');
        header.className = 'floating-panel-header';
        header.style.width = '100%';
        header.style.height = '20px'; // Set height to 20px
        header.style.backgroundColor = '#b5b3b0'; // Updated background color
        header.style.borderBottom = '1px solid #b5b3b0';
        header.style.cursor = 'move';
        header.style.display = 'flex';
        header.style.justifyContent = 'space-between'; // Align items to the sides
        header.style.alignItems = 'center';
        header.style.padding = '0 5px'; // Adjust padding to fit buttons
        header.style.boxSizing = 'border-box'; // Include padding in width calculation
        header.style.position = 'relative';
        header.style.zIndex = '1'; // Ensure header is above iframe

        // Create the title element
        const titleElement = document.createElement('div');
        titleElement.className = 'floating-panel-title';
        titleElement.innerHTML = title; // Support HTML syntax
        titleElement.style.flexGrow = '1';
        titleElement.style.textAlign = 'left'; // Justify title to the left
        titleElement.style.fontFamily = 'monospace'; // Monospace font
        titleElement.style.userSelect = 'none'; // Prevent text selection

        // Create the loading ticker
        const loadingTicker = document.createElement('div');
        loadingTicker.innerHTML = 'Loading...';
        loadingTicker.style.marginLeft = '10px';
        loadingTicker.style.display = 'none'; // Hide by default

        // Create the button container
        const buttonContainer = document.createElement('div');
        buttonContainer.className = 'floating-panel-buttons';
        buttonContainer.style.display = 'flex';
        buttonContainer.style.gap = '5px';
        buttonContainer.style.margin = '0'; // Remove margin to fit buttons

        // Create the close button
        const closeButton = document.createElement('button');
        closeButton.className = 'floating-panel-close';
        closeButton.innerHTML = 'âœ–';
        closeButton.style.border = 'none';
        closeButton.style.background = 'none';
        closeButton.style.cursor = 'pointer';
        closeButton.style.fontSize = '16px';
        closeButton.style.color = '#333';
        closeButton.style.padding = '5px'; // Add padding to the button
        closeButton.addEventListener('click', () => {
            lowerZIndexForHigherPanels(panel);
            highestZIndex--;
            document.body.removeChild(panel);
        });

        // Create the maximize toggle button
        const maximizeToggleButton = document.createElement('button');
        maximizeToggleButton.className = 'floating-panel-maximize';
        maximizeToggleButton.innerHTML = 'ðŸ—–';
        maximizeToggleButton.style.border = 'none';
        maximizeToggleButton.style.background = 'none';
        maximizeToggleButton.style.cursor = 'pointer';
        maximizeToggleButton.style.fontSize = '16px';
        maximizeToggleButton.style.color = '#333';
        maximizeToggleButton.style.padding = '5px'; // Add padding to the button
        let isMaximized = false;
        let lastSize = {
            width: panel.style.width,
            height: panel.style.height,
            top: panel.style.top,
            left: panel.style.left
        };

        function toggleMaximize() {
            bringToFront();
            if (isMaximized) {
                panel.style.width = lastSize.width;
                panel.style.height = lastSize.height;
                panel.style.top = lastSize.top;
                panel.style.left = lastSize.left;
                header.style.cursor = 'move';
                maximizeToggleButton.innerHTML = 'ðŸ—–';
            } else {
                lastSize = {
                    width: panel.style.width,
                    height: panel.style.height,
                    top: panel.style.top,
                    left: panel.style.left
                };
                panel.style.width = 'calc(100% - 10px - 8px)'; // padding + border
                panel.style.height = 'calc(100% - 10px)';
                panel.style.top = '5px';
                panel.style.left = '5px';
                header.style.cursor = 'default';
                maximizeToggleButton.innerHTML = 'â';
            }
            isMaximized = !isMaximized;
        }

        // Add double-click event listener to the header to toggle maximize
        header.addEventListener('dblclick', toggleMaximize);
        maximizeToggleButton.addEventListener('click', toggleMaximize);

        // Append buttons to the button container
        buttonContainer.appendChild(maximizeToggleButton);
        buttonContainer.appendChild(closeButton);

        // Append the title element, loading ticker, and button container to the header
        header.appendChild(titleElement);
        header.appendChild(loadingTicker);
        header.appendChild(buttonContainer);

        // Create the iframe to load the URL
        const iframe = document.createElement('iframe');
        iframe.className = 'floating-panel-iframe';
        iframe.src = url;
        iframe.style.width = 'calc(100% - 8px)'; // Adjust width to match border
        iframe.style.height = 'calc(100% - 20px)'; // Adjust height to match header
        iframe.style.border = '4px solid #e6e6e5';
        iframe.style.overflow = 'auto'; // Allow iframe to scroll

        // Show loading ticker when iframe is loading
        iframe.addEventListener('load', () => {
            loadingTicker.style.display = 'none';
        });
        iframe.addEventListener('beforeunload', () => {
            loadingTicker.style.display = 'block';
        });

        // Append the header and iframe to the panel
        panel.appendChild(header);
        panel.appendChild(iframe);

        // Make the panel draggable
        let isDragging = false;
        let offsetX, offsetY;

        function onMouseMove(e) {
            if (isDragging) {
                panel.style.left = `${e.clientX - offsetX}px`;
                panel.style.top = `${e.clientY - offsetY}px`;
            }
        }

        function onMouseUp() {
            isDragging = false;
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        }

        header.addEventListener('mousedown', (e) => {
            if (!isMaximized) {
                isDragging = true;
                offsetX = e.clientX - panel.getBoundingClientRect().left;
                offsetY = e.clientY - panel.getBoundingClientRect().top;
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            }
        });

        // Append the panel to the body
        document.body.appendChild(panel);
    }


    const graphQuery = `query GenericGraph{nodes{...Details} links: edges{source{...Details} target{...Details}}} fragment Details on GraphElement {id name: label type color}`;
    const nodeTypesQuery = `query GraphTypes{graph{name nodeTypes: nodeTypeCounts{name count: value} edgeTypes: edgeTypeCounts{name count: value}}}`;

    const Graph = ForceGraph3D()(document.getElementById('3d-graph'))
        .nodeColor('color')
        .nodeVal(8)
        .nodeLabel(node => `${node.type}: '${node.name}'`)
        .onEngineStop(() => Graph.zoomToFit(400));

    const nodeTypeColor = {}
    const nodeTypeVisibility = {};

    function fetchGraphQL(payload) {
        return fetch(
            '/graphql',
            {
                method: 'post',
                headers: {Accept: 'application/json', 'Content-Type': 'application/json'},
                body: JSON.stringify(payload),
                credentials: 'include',
            }).then((response) => response.json());
    }


    function updateGraph(gData) {
        Graph.graphData(gData).zoomToFit(400);
    }


    function getVisible(gData) {
        const visibleNodes = []
        gData.nodes.forEach((node) => {
            if (node.type in nodeTypeVisibility && nodeTypeVisibility[node.type]) {
                visibleNodes.push(node);
            }
        });
        const visibleLinks = [];
        gData.links.forEach((link) => {
            if (visibleNodes.find((node) => node.id === link.source.id) && visibleNodes.find((node) => node.id === link.target.id)) {
                visibleLinks.push(link);
            }
        });

        return {nodes: visibleNodes, links: visibleLinks};
    }

    function setAllNodeTypeVisibility(value) {
        Object.keys(nodeTypeVisibility).forEach(key => {
            nodeTypeVisibility[key] = value;
        });
    }

    function updateNodeTypeColorMapping(nodes) {
        nodes.forEach(node => {
            if (!nodeTypeColor[node.type]) {
                nodeTypeColor[node.type] = node.color;
            }
        });
    }


    function createPanel(graph, gData) {
        updateNodeTypeColorMapping(gData.nodes);
        const pane = new Tweakpane.Pane();
        const tab = pane.addTab({
            pages: [
                {title: 'Legend'},
                {title: 'Tools'}
            ],
        });

        // Legend tab

        tab.pages[0].addButton({title: 'Zoom - Fit to Page'}).on('click', () => Graph.zoomToFit(400));
        tab.pages[0].addButton({title: 'Visibility - All On'}).on('click', () => {
            setAllNodeTypeVisibility(true);
            updateGraph(gData);
            pane.refresh();
        });
        tab.pages[0].addButton({title: 'Visibility - All Off'}).on('click', () => {
            setAllNodeTypeVisibility(false);
            const visibleGData = getVisible(gData);
            updateGraph(visibleGData);
            pane.refresh();
        });

        graph.nodeTypes.forEach(nodeType => {
            info = `V: ${nodeType.count}`
            edgeType = graph.edgeTypes.find((t) => t.name === nodeType.name);
            if (edgeType) {
                info += `, E: ${edgeType.count}`;
            }

            const f = tab.pages[0].addFolder({title: `${nodeType.name} [${info}]`});

            f.addBinding(nodeTypeColor, nodeType.name, {label: 'Color'})
                .on('change', (ev) => {
                    gData.nodes.forEach(node => {
                        if (node.type === nodeType.name) {
                            node.color = ev.value;
                        }
                    });
                    const visibleGData = getVisible(gData);
                    updateGraph(visibleGData);
                });

            nodeTypeVisibility[nodeType.name] = true;
            f.addBinding(nodeTypeVisibility, nodeType.name, {label: 'Visible'})
                .on('change', (ev) => {
                    const visibleGData = getVisible(gData);
                    updateGraph(visibleGData);
                });
        });

        // Links tab
        tab.pages[1].addButton({title: 'GraphiQL'}).on('click', () => createFloatingPanel('/graphql', 'Graph<i>i</i>QL'));
        tab.pages[1].addButton({title: 'GraphQL Voyager'}).on('click', () => createFloatingPanel('/voyager', 'GraphQL Voyager'));
        tab.pages[1].addButton({title: 'RapiDoc'}).on('click', () => createFloatingPanel('/rapidoc', 'RapiDoc'));
        tab.pages[1].addButton({title: 'Metrics'}).on('click', () => createFloatingPanel('/metrics', 'Metrics'));
    }

    fetchGraphQL({query: graphQuery})
        .then((responseJson) => responseJson.data)
        .then((gData) => {
            gData.nodes = gData.nodes.map((node) => {
                node.id = murmurhash3_32_gc(node.id, 1);
                return node;
            });
            gData.links = gData.links.map((link) => {
                return {"source": murmurhash3_32_gc(link.source.id, 1), "target": murmurhash3_32_gc(link.target.id, 1)};
            });
            updateGraph(gData);
            fetchGraphQL({query: nodeTypesQuery})
                .then((responseJson) => responseJson.data)
                .then((data) => {
                    createPanel(data.graph, gData);
                });
        });
</script>
</body>
</html>